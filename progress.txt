# Ralph Progress Log
# Project: Coach Portal MVP
# Location: /Users/wavescapital/hybrid-base-coach-portal
# Started: Thu Jan 29 14:40:08 EST 2026
#
# This file is generated and maintained by Ralph.
# See: https://github.com/thecgaigroup/ralph-cc-loop
---

## Codebase Patterns
- Expo SDK 54 with Expo Router v6 (file-based routing in app/ directory)
- Entry point is `expo-router/entry` in package.json (not App.tsx)
- Dark theme default: background=#0A0A0A, text=#F5FAFF, muted=#8D9299
- Test coach ID: `test-coach-uuid-0001` from lib/testCoach.ts
- Supabase project ID: uevqwbdumouoghymcqtc
- Backend URL: https://api.hybridbase.app
- Quality checks: `npx tsc --noEmit`, `npx expo lint`, `npx expo export --platform web`
- Theme: import `useTheme` from `lib/ThemeContext` for colors, spacing, typography, springs
- Theme spring configs: `theme.spring`, `theme.springLight`, `theme.springBouncy` for Framer Motion
- ESLint 9 with eslint-config-expo flat config
- When initializing Expo in non-empty dir, use temp dir and copy files over
- Layout components in `components/layout/` - DashboardLayout wraps pages with Header + Sidebar (desktop) / BottomTabs (mobile)
- Responsive breakpoint at 768px: useWindowDimensions().width >= 768 for desktop
- Framer Motion AnimatePresence + motion.div used for layout transitions on web
- Nav items: Dashboard (/), Programs (/programs), Profile (/profile)
- usePathname() from expo-router for active route detection
- Supabase migrations live in `supabase/migrations/` with numeric prefixes (001_, 002_, etc.)
- Use `IF NOT EXISTS` / `ON CONFLICT DO NOTHING` for idempotent migrations
- Test coach user_id is `00000000-0000-0000-0000-000000000001` (dummy UUID for MVP)

---

## [Iteration 1] 2026-01-29 - US-001
- Initialized Expo project with TypeScript blank template (SDK 54)
- Installed: expo-router, react-dom, react-native-web, @expo/metro-runtime, framer-motion, zustand, @supabase/supabase-js
- Created folder structure: app/, components/, lib/, state/, types/
- Set up Expo Router with file-based routing (app/_layout.tsx, app/index.tsx)
- Created lib/supabase.ts (typed Supabase client) and lib/testCoach.ts (TEST_COACH_ID constant)
- Created .env.local and .env.example with required env vars
- Configured app.json with dark theme, web bundler: metro, scheme: coach-portal
- Files changed: package.json, app.json, tsconfig.json, eslint.config.js, app/_layout.tsx, app/index.tsx, lib/supabase.ts, lib/testCoach.ts, .env.local, .env.example, .gitignore
- **Learnings for future iterations:**
  - `npx create-expo-app` won't run in a non-empty directory; use temp dir + copy
  - ESLint auto-installs on first `npx expo lint` run (creates eslint.config.js)
  - Empty directories cause lint errors - ensure directories have files before linting
  - `expo-router/entry` must be set as "main" in package.json for routing to work
---

## [Iteration 2] 2026-01-29 - US-002
- Created Supabase migrations for coaches and coach_programs tables
- coaches table: id, user_id, display_name, slug, bio, profile_photo_url, social_links, verification_status, created_at
- coach_programs table: id, coach_id, title, slug, description, duration_weeks, difficulty, focus, equipment, template_data, source_pdf_url, status, created_at
- Added auto-created columns to exercises table (is_auto_created, auto_created_by, auto_created_at) with IF NOT EXISTS guards
- RLS policies: coaches read/write own data, public read published programs and verified coaches
- Seeded test coach (test-coach-uuid-0001, display_name "Test Coach", slug "test-coach")
- Files changed: supabase/migrations/001_coaches_table.sql, 002_coach_programs_table.sql, 003_exercises_auto_created.sql, 004_seed_test_coach.sql, prd.json
- **Learnings for future iterations:**
  - SQL migrations don't affect TypeScript checks - `npx tsc --noEmit` and lint still pass
  - Empty directories (components/, state/, types/) cause `npx expo lint` to fail with "no files matching pattern" - run lint on specific directories with files instead
  - Use DO $$ blocks for conditional ALTER TABLE to make migrations idempotent
  - coach_programs has UNIQUE(coach_id, slug) constraint - must handle slug collisions in app code
---

## [Iteration 3] 2026-01-29 - US-002B
- Created Supabase Storage migration (005_storage_buckets.sql) for coach-pdfs and coach-photos buckets
- coach-pdfs: private bucket, 50MB limit, coaches can only access their own folder (by auth.uid)
- coach-photos: public bucket, 5MB limit, publicly readable, coaches manage their own folder
- Storage policies use storage.foldername(name)[1] = auth.uid()::text for folder-based access control
- Created lib/storage.ts with uploadPDF and uploadProfilePhoto helper functions
- Both helpers use timestamp-prefixed filenames to prevent collisions
- Files changed: supabase/migrations/005_storage_buckets.sql, lib/storage.ts, prd.json
- **Learnings for future iterations:**
  - Supabase Storage buckets are created via INSERT INTO storage.buckets, not DDL
  - Use ON CONFLICT (id) DO NOTHING for idempotent bucket creation
  - Storage policies go on storage.objects table, not on the bucket itself
  - storage.foldername(name) returns array of folder segments - use [1] for top-level folder
  - coach-pdfs is private (no public URL works without signed URL in production), but getPublicUrl still returns a URL string for storage reference
---

## [Iteration 4] 2026-01-29 - US-013
- Created lib/theme.ts with complete theme object: colors (core, phase, workout type, intensity, status, zone), typography scale (heading1-4, body, bodySmall, caption), spacing system (xs-xxl), border radius (sm-round), Framer Motion spring configs (spring, springLight, springBouncy)
- Created lib/ThemeContext.tsx with ThemeProvider component and useTheme hook
- Updated app/_layout.tsx to wrap app in ThemeProvider
- Files changed: lib/theme.ts, lib/ThemeContext.tsx, app/_layout.tsx
- **Learnings for future iterations:**
  - Theme is accessed via `useTheme()` hook which returns the full theme object
  - Spring configs are at top level: `theme.spring`, `theme.springLight`, `theme.springBouncy`
  - Color maps (phase, workoutType, intensity, status) use `Record<string, string>` for flexible key lookup
  - Zone colors use `Record<number, string>` for numeric zone IDs (1-5)
  - `npx expo lint` still fails on empty `components/` dir - use `npx expo lint ./app ./lib` to target specific dirs
---

## [Iteration 5] 2026-01-29 - US-004
- Created types/program.ts with full program type hierarchy: ProgramStructure, Week, Day, Exercise, ExerciseSet, CardioSegment
- Created lib/pdfParsing.ts with two main functions:
  - `extractMarkdown(pdfUrl)`: calls EXPO_PUBLIC_BACKEND_URL/pdf/extract to get markdown from PDF via MinerU
  - `parseProgram(markdown)`: calls OpenRouter API with Claude Sonnet (anthropic/claude-sonnet-4-20250514) to parse markdown into ProgramStructure JSON
- Handles supersets (grouped with supersetGroup number), EMOM workouts (emom flag + duration), cardio segments
- Retry logic: 3 attempts with exponential backoff (1s, 2s delays)
- 30s timeout via AbortController on all fetch calls
- Validates response has title, durationWeeks, and non-empty weeks array
- Files changed: types/program.ts, lib/pdfParsing.ts
- **Learnings for future iterations:**
  - OpenRouter API uses standard OpenAI chat completions format at https://openrouter.ai/api/v1/chat/completions
  - LLM responses may include markdown code fences even when told not to - always strip them
  - Use temperature 0.1 for structured extraction to minimize hallucination
  - The types in types/program.ts are the canonical program structure used throughout the app
  - AbortController + setTimeout pattern works for fetch timeout in both Node and browser
---

## [Iteration 6] 2026-01-29 - US-005
- Created types/exercise.ts with Exercise (DB record) and ExerciseMatch (matching result) interfaces
- Created lib/exerciseMatching.ts with:
  - `normalizeName(name)`: lowercase, remove accents (NFD), remove parentheticals, alphanumeric+spaces only
  - `matchExercises(names, options)`: matches exercise names against DB with 3-tier strategy
  - Exact match on name_normalized â†’ confidence 1.0
  - Fuzzy match via fuzzy_search_exercises RPC â†’ confidence 0.55â€“0.99
  - No match â†’ confidence 0 with suggested_name, or auto-create if enabled
  - `autoCreateExercise`: inserts with is_auto_created=true, provider_source='coach_upload'
- Files changed: types/exercise.ts, lib/exerciseMatching.ts, prd.json
- **Learnings for future iterations:**
  - The exercises table has a `fuzzy_search_exercises` RPC for similarity matching
  - Exercise matching returns ExerciseMatch[] with confidence scores for UI badges
  - normalizeName is reusable for any name-comparison logic
  - Auto-created exercises get provider_source='coach_upload' to distinguish from curated ones
---

## [Iteration 7] 2026-01-29 - US-006
- Created responsive dashboard layout with 4 components:
  - `components/layout/DashboardLayout.tsx`: Main wrapper with responsive detection (768px breakpoint)
  - `components/layout/Header.tsx`: Top bar with "Coach Portal" title and coach name/avatar
  - `components/layout/Sidebar.tsx`: Desktop left sidebar with nav items (Dashboard, Programs, Profile)
  - `components/layout/BottomTabs.tsx`: Mobile bottom tab navigation
- Desktop (>=768px): Header + Sidebar on left + content area
- Mobile (<768px): Header + content area + BottomTabs at bottom
- Framer Motion AnimatePresence for smooth sidebar/tabs transitions on resize
- Active route highlighting with neonPrimary color and indicator bars
- usePathname from expo-router for route detection
- Files changed: components/layout/DashboardLayout.tsx, Header.tsx, Sidebar.tsx, BottomTabs.tsx, prd.json
- **Learnings for future iterations:**
  - Framer Motion `motion.div` works in Expo web builds (rendered as HTML div)
  - Use `as never` cast on router.push paths to avoid strict typing issues with expo-router
  - useWindowDimensions is reactive - component re-renders on resize automatically
  - AnimatePresence mode="wait" prevents layout flash during sidebar/tabs toggle
  - Emoji icons (ðŸ“ŠðŸ“‹ðŸ‘¤) work cross-platform for MVP; replace with proper icon library later
---
